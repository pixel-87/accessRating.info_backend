<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Map | AccessRating</title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
      #map {
        height: 500px;
        width: 100%;
      }
      #business-panel,
      #business-panel-overlay {
        z-index: 20 !important;
      }

      /* Only set background color for map container */
      .leaflet-container {
        background: #aadaff;
        z-index: 1 !important;
      }

      @media (max-width: 768px) {
        #business-panel {
          max-height: 90vh;
          overflow-y: auto;
        }
        #business-panel-overlay {
          z-index: 2000;
        }
      }
    </style>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  </head>
  <body class="bg-gray-100">
    <!-- Navigation -->
    <div hx-get="nav.html" hx-trigger="load" hx-swap="outerHTML"></div>

    <main class="container mx-auto py-8">
      <h1 class="text-3xl font-bold mb-6">Business Map</h1>

      <!-- Filter Controls -->
      <div class="bg-white rounded-lg shadow-md p-4 mb-6">
        <h2 class="text-lg font-semibold mb-4">Filter Businesses</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <!-- Search -->
          <div>
            <label
              for="search"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Search</label
            >
            <input
              type="text"
              id="search"
              placeholder="Business name, address..."
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <!-- Business Type -->
          <div>
            <label
              for="business-type"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Type</label
            >
            <select
              id="business-type"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="all">All Types</option>
              <option value="cafe">Cafe</option>
              <option value="restaurant">Restaurant</option>
              <option value="shop">Shop</option>
              <option value="pub">Pub</option>
              <option value="hotel">Hotel</option>
              <option value="office">Office</option>
              <option value="healthcare">Healthcare</option>
              <option value="entertainment">Entertainment</option>
              <option value="education">Education</option>
              <option value="transport">Transport</option>
              <option value="other">Other</option>
            </select>
          </div>

          <!-- Minimum Rating -->
          <div>
            <label
              for="min-rating"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Min Rating</label
            >
            <select
              id="min-rating"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Any Rating</option>
              <option value="1">1+ Star</option>
              <option value="2">2+ Stars</option>
              <option value="3">3+ Stars</option>
              <option value="4">4+ Stars</option>
              <option value="5">5 Stars</option>
            </select>
          </div>

          <!-- Distance Filter -->
          <div>
            <label
              for="radius"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Within</label
            >
            <div class="flex space-x-2">
              <select
                id="radius"
                class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="">Any Distance</option>
                <option value="5">5 miles</option>
                <option value="10">10 miles</option>
                <option value="25">25 miles</option>
                <option value="50">50 miles</option>
                <option value="100">100 miles</option>
              </select>
              <button
                id="use-location"
                class="px-3 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                title="Use my location"
              >
                üìç
              </button>
            </div>
          </div>
        </div>

        <!-- Apply/Clear Buttons -->
        <div class="flex justify-end space-x-2 mt-4">
          <button
            id="clear-filters"
            class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            Clear
          </button>
          <button
            id="apply-filters"
            class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            Apply Filters
          </button>
        </div>
      </div>

      <div id="map" class="mb-8"></div>
    </main>

    <!-- Slide-up panel for business details -->
    <div
      id="business-panel-overlay"
      class="fixed inset-0 bg-black bg-opacity-40 z-[2000] hidden"
    ></div>
    <div
      id="business-panel"
      class="fixed left-0 right-0 bottom-0 z-[2001] max-h-[80vh] bg-white rounded-t-2xl shadow-lg p-4 transition-transform duration-300 translate-y-full"
      style="will-change: transform"
    >
      <!-- Loading spinner -->
      <div
        id="panel-loading"
        class="hidden flex items-center justify-center py-8"
      >
        <div
          class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"
        ></div>
        <span class="ml-2 text-gray-600">Loading business details...</span>
      </div>

      <!-- Error message -->
      <div
        id="panel-error"
        class="hidden bg-red-50 border border-red-200 rounded-md p-4"
      >
        <div class="flex">
          <div class="text-red-400">‚ö†Ô∏è</div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-red-800">
              Error loading business details
            </h3>
            <p class="mt-1 text-sm text-red-700">
              Please try again later or check your connection.
            </p>
            <button
              onclick="hideBusinessPanel()"
              class="mt-2 text-sm text-red-600 hover:text-red-500 underline"
            >
              Close
            </button>
          </div>
        </div>
      </div>

      <!-- Business card content will be loaded here -->
      <div id="panel-content"></div>
    </div>

    <!-- Footer -->
    <div hx-get="footer.html" hx-trigger="load" hx-swap="outerHTML"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // Initialize map with simple settings
      var map = L.map("map").setView([52.5, -1.5], 6);
      var markers = []; // Store all markers for filtering
      var userLocation = null; // Store user's location for distance filtering

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "¬© OpenStreetMap",
      }).addTo(map);

      // Function to clear all markers from map
      function clearMarkers() {
        markers.forEach((marker) => map.removeLayer(marker));
        markers = [];
      }

      // Function to build filter URL parameters
      function buildFilterParams() {
        const params = new URLSearchParams();

        const search = document.getElementById("search").value.trim();
        if (search) params.append("search", search);

        const businessType = document.getElementById("business-type").value;
        if (businessType && businessType !== "all")
          params.append("business_type", businessType);

        const minRating = document.getElementById("min-rating").value;
        if (minRating) params.append("min_rating", minRating);

        const radius = document.getElementById("radius").value;
        if (radius && userLocation) {
          params.append("lat", userLocation.lat);
          params.append("lng", userLocation.lng);
          params.append("radius", radius);
        }

        return params.toString();
      }

      // Function to fetch and display businesses with current filters
      function loadBusinesses() {
        const filterParams = buildFilterParams();
        const url = `http://localhost:8000/api/v1/business-locations/${
          filterParams ? "?" + filterParams : ""
        }`;

        fetch(url)
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((businesses) => {
            // Clear existing markers
            clearMarkers();

            // Add new markers
            businesses.forEach((business) => {
              if (!isNaN(business.latitude) && !isNaN(business.longitude)) {
                var marker = L.marker([
                  business.latitude,
                  business.longitude,
                ]).addTo(map);

                // Add marker to our tracking array
                markers.push(marker);

                // Add click handler
                marker.on("click", function () {
                  showBusinessPanel(business.id);
                });

                // Optional: Add popup with basic info
                const popupContent = `
                  <strong>${business.name}</strong><br>
                  ${business.address}<br>
                  Rating: ${business.accessibility_level}/5
                  ${
                    business.distance
                      ? `<br>Distance: ${business.distance} miles`
                      : ""
                  }
                `;
                marker.bindPopup(popupContent);
              }
            });

            // Auto-fit map to show all markers if we have results
            if (markers.length > 0) {
              const group = new L.featureGroup(markers);
              map.fitBounds(group.getBounds().pad(0.1));
            }
          })
          .catch((error) => {
            alert("Error loading businesses. Please try again.");
          });
      }

      // Get user's location
      function getUserLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function (position) {
              userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };

              // Optional: Add a marker for user location
              L.marker([userLocation.lat, userLocation.lng])
                .addTo(map)
                .bindPopup("Your location")
                .openPopup();

              // Center map on user location
              map.setView([userLocation.lat, userLocation.lng], 12);

              alert("Location found! You can now use distance filters.");
            },
            function (error) {
              alert(
                "Could not get your location. Distance filtering will not be available."
              );
            }
          );
        } else {
          alert("Geolocation is not supported by this browser.");
        }
      }

      // Event listeners
      document
        .getElementById("apply-filters")
        .addEventListener("click", loadBusinesses);

      document
        .getElementById("clear-filters")
        .addEventListener("click", function () {
          document.getElementById("search").value = "";
          document.getElementById("business-type").value = "all";
          document.getElementById("min-rating").value = "";
          document.getElementById("radius").value = "";
          loadBusinesses();
        });

      document
        .getElementById("use-location")
        .addEventListener("click", getUserLocation);

      // Make overlay clickable to close the panel
      document
        .getElementById("business-panel-overlay")
        .addEventListener("click", function (event) {
          hideBusinessPanel();
        });

      // Use event delegation for dynamic content - listen on document
      document.addEventListener("click", function (event) {
        // Check if clicked element has the close class
        if (event.target.classList.contains("close-business-panel")) {
          hideBusinessPanel();
          event.preventDefault();
          event.stopPropagation();
        }
        // Prevent panel from closing when clicking inside the panel (but not close button)
        else if (
          event.target.closest("#business-panel") &&
          !event.target.closest("#business-panel-overlay")
        ) {
          event.stopPropagation();
        }
      });

      // Allow Enter key in search box to trigger filter
      document
        .getElementById("search")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            loadBusinesses();
          }
        });

      // Load initial businesses on page load
      loadBusinesses();

      // Show the slide-up panel and load business card via HTMX
      function showBusinessPanel(businessId) {
        var overlay = document.getElementById("business-panel-overlay");
        var panel = document.getElementById("business-panel");
        var loading = document.getElementById("panel-loading");
        var error = document.getElementById("panel-error");
        var content = document.getElementById("panel-content");

        // Reset any inline styles that might interfere
        overlay.style.display = "";
        panel.style.transform = "";

        // Show panel and loading state
        overlay.classList.remove("hidden");
        panel.classList.remove("translate-y-full");
        panel.classList.add("translate-y-0");

        // Show loading, hide error and content
        loading.classList.remove("hidden");
        error.classList.add("hidden");
        content.innerHTML = "";

        // Use HTMX to load the business card into content div
        content.setAttribute(
          "hx-get",
          `http://localhost:8000/api/v1/businesses/${businessId}/card/`
        );
        content.setAttribute("hx-trigger", "load");
        content.setAttribute("hx-swap", "innerHTML");

        // Add HTMX event listeners for this request
        content.addEventListener(
          "htmx:afterRequest",
          function (event) {
            loading.classList.add("hidden");
            if (event.detail.successful) {
              // Success - content is already loaded
            } else {
              // Error - show error message
              error.classList.remove("hidden");
            }
          },
          { once: true }
        );

        htmx.process(content);
      }

      // Hide the slide-up panel
      function hideBusinessPanel() {
        var overlay = document.getElementById("business-panel-overlay");
        var panel = document.getElementById("business-panel");
        var loading = document.getElementById("panel-loading");
        var error = document.getElementById("panel-error");
        var content = document.getElementById("panel-content");

        // Force hide with both classes and inline styles
        overlay.classList.add("hidden");
        overlay.style.display = "none"; // Force hide

        panel.classList.remove("translate-y-0");
        panel.classList.add("translate-y-full");
        panel.style.transform = "translateY(100%)"; // Force slide down

        // Reset states
        loading.classList.add("hidden");
        error.classList.add("hidden");
        content.innerHTML = "";

        // Reset the hx-get attribute to ensure re-triggering
        content.removeAttribute("hx-get");
        content.removeAttribute("hx-trigger");
        content.removeAttribute("hx-swap");
      }

      // Accessibility: Close panel with Escape key and trap focus
      document.addEventListener("keydown", function (event) {
        var overlay = document.getElementById("business-panel-overlay");
        var panel = document.getElementById("business-panel");
        if (!overlay.classList.contains("hidden")) {
          // ESC closes panel
          if (event.key === "Escape") {
            hideBusinessPanel();
          }
          // Trap focus inside panel
          if (event.key === "Tab") {
            var focusable = panel.querySelectorAll(
              'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            focusable = Array.prototype.slice.call(focusable);
            if (focusable.length === 0) return;
            var first = focusable[0];
            var last = focusable[focusable.length - 1];
            var active = document.activeElement;
            if (!panel.contains(active)) {
              first.focus();
              event.preventDefault();
            } else {
              if (!event.shiftKey && active === last) {
                first.focus();
                event.preventDefault();
              } else if (event.shiftKey && active === first) {
                last.focus();
                event.preventDefault();
              }
            }
          }
        }
      });

      // Add ARIA attributes to panel for modal semantics
      var panel = document.getElementById("business-panel");
      panel.setAttribute("role", "dialog");
      panel.setAttribute("aria-modal", "true");
      panel.setAttribute("aria-label", "Business details");
    </script>
  </body>
</html>
