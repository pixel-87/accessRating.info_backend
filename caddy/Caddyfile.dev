# Dev Caddyfile - plain HTTP, no ACME
# This file is for local development only. It disables automatic HTTPS to avoid
# Let's Encrypt ACME challenges during local containerized development.

# Turn off auto HTTPS for dev
{
  auto_https off
}

# Serve on :80 (container) - docker maps to host port (e.g., 8080)
:80 {
  # Static frontend root; specific handles below will serve or proxy as appropriate
  root * /app/frontend
  encode gzip zstd

  # Static assets
  handle_path /static/* {
    root * /app/frontend
    file_server
    header Cache-Control "public, max-age=31536000, immutable"
  }

  # Media (if any)
  handle_path /media/* {
    root * /app/media
    file_server
    header Cache-Control "public, max-age=31536000"
  }

  # API proxy to Django backend
  handle_path /api/* {
    reverse_proxy web:8000 {
      header_up Host {host}
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
    }
  }

  # Healthcheck proxy
  handle /health/* {
    reverse_proxy web:8000
    header Cache-Control "no-cache, no-store, must-revalidate"
  }

  # Fallback for everything else -> index.html (SPA)
  handle {
    try_files {path} /index.html
    file_server
  }

  log {
    output stdout
    format json
  }
}
